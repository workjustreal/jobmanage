<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" />
    <style>
      body {
        font-family: 'Kanit', sans-serif;
        padding: 20px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 4px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
      }
      @media print {
        button {
          display: none;
        }
      }
      #saveImageBtn {
        margin-top: 20px;
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="table-container"></div>

    <button id="saveImageBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
      const stored = localStorage.getItem('tableData');
      const selectedWeekIndex = 4; // ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ default ‡πÉ‡∏ô index.html

      if (!stored) {
        document.getElementById('table-container').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô localStorage");
      }

      const data = JSON.parse(stored);

      function formatDate(d) {
        const date = new Date(d);
        return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
      }

      function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - ((day + 6) % 7);
        d.setDate(diff);
        return d;
      }

      function generateWeeks(range = 4) {
        const now = new Date();
        const monday = getMonday(now);
        const options = [];
        for (let i = -range; i <= range; i++) {
          const start = new Date(monday);
          start.setDate(start.getDate() + i * 7);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          options.push({ start, label: `${formatDate(start)} - ${formatDate(end)}` });
        }
        return options;
      }

      const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];
      const weeks = generateWeeks(4);
      const selectedWeek = weeks[selectedWeekIndex];

      const container = document.getElementById('table-container');
      const table = document.createElement('table');
      table.className = 'table table-bordered';

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á thead
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headRow.innerHTML = `
        <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th style="min-width: 100px;">‡∏ä‡∏∑‡πà‡∏≠</th>
      `;

      const current = new Date(selectedWeek.start);
      for (let i = 0; i < 7; i++) {
        const th = document.createElement('th');
        th.style.minWidth = "80px";
        th.textContent = `${thaiDays[current.getDay()]} ${formatDate(current)}`;
        headRow.appendChild(th);
        current.setDate(current.getDate() + 1);
      }

      thead.appendChild(headRow);
      table.appendChild(thead);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á tbody
      const tbody = document.createElement('tbody');
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.name}</td>
        `;
        item.numbers.forEach(num => {
          row.innerHTML += `<td>${num}</td>`;
        });
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ
      document.getElementById('saveImageBtn').addEventListener('click', () => {
        html2canvas(table).then(canvas => {
          const link = document.createElement('a');
          link.download = '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        });
      });

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
      setTimeout(() => {
        document.getElementById('saveImageBtn').click();
      }, 1000);
    </script>
  </body>
</html>
