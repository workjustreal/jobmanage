<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Job)</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap">
    <style>
      body {
        font-family: 'Kanit', sans-serif;
      }
      .drag-handle {
        cursor: grab;
        user-select: none;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        text-align: center;
        padding: 4px;
      }
      input[type="number"] {
        width: 40px;
        text-align: center;
      }
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body>
    <div class="mb-3 px-5 mt-2">
      <label for="weekSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
      <select id="weekSelect" class="form-select"></select>
    </div>
    <div class="container-fluid">
      <div id="capture">
        <table class="table table-striped">
          <thead id="weekHeader">
            <tr>
              <th style="width: 50px;"></th>
              <th style="width: 50px;"></th>
              <th style="width: 150px;">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th style="width: 120px;">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</th>
              <th style="width: 120px;">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</th>
              <th style="width: 120px;">‡∏û‡∏∏‡∏ò</th>
              <th style="width: 120px;">‡∏û‡∏§‡∏´‡∏±‡∏™</th>
              <th style="width: 120px;">‡∏®‡∏∏‡∏Å‡∏£‡πå</th>
              <th style="width: 120px;">‡πÄ‡∏™‡∏≤‡∏£‡πå</th>
              <th style="width: 120px;">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</th>
              <th style="width: 50px;"></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
    <button class="btn btn-info mb-2" onclick="addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    <button class="btn btn-primary mb-2" onclick="saveDataToStorage()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="btn btn-success mb-2" onclick="saveAndOpenPrintView()">üì∑ ‡πÄ‡∏ã‡∏ü‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>

    <div class="modal fade" id="numberModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="rowValue" class="form-label">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</label>
              <input type="number" class="form-control" id="rowValue" min="0" value="0">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="button" class="btn btn-primary" id="confirmRowValue">‡∏ï‡∏Å‡∏•‡∏á</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
      const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];

      function formatDate(d) {
        return d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
      }

      function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - ((day + 6) % 7);
        d.setDate(diff);
        return d;
      }

      function generateWeeks(range = 4) {
        const now = new Date();
        const monday = getMonday(now);
        const options = [];

        for (let i = -range; i <= range; i++) {
          const start = new Date(monday);
          start.setDate(start.getDate() + i * 7);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          options.push({ start, label: `${formatDate(start)} - ${formatDate(end)}` });
        }

        return options;
      }

      function renderWeekHeader(startDate) {
        const weekHeader = document.getElementById('weekHeader').querySelector('tr');

        // üîÅ ‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 3 ‡∏ñ‡∏∂‡∏á 9 (7 ‡∏ß‡∏±‡∏ô)
        for (let i = 0; i < 7; i++) {
          weekHeader.removeChild(weekHeader.children[3]); // ‡∏•‡∏ö‡∏ó‡∏µ‡πà index 3 ‡∏ã‡πâ‡∏≥ 7 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        }

        // ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà 7 ‡∏ß‡∏±‡∏ô
        const current = new Date(startDate);
        for (let i = 0; i < 7; i++) {
          const th = document.createElement('th');
          th.style.width = '120px';
          th.textContent = `${thaiDays[current.getDay()]} ${formatDate(current)}`;
          
          // ‚úÖ ‡πÅ‡∏ó‡∏£‡∏Å‡∏Å‡πà‡∏≠‡∏ô <th> ‡∏•‡∏ö (index 10) ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ "‡∏ä‡∏∑‡πà‡∏≠" ‡∏≠‡∏¢‡∏π‡πà index 2 ‡∏ï‡∏•‡∏≠‡∏î
            weekHeader.insertBefore(th, weekHeader.children[3 + i]);
          current.setDate(current.getDate() + 1);
        }
      }


      function addRow() {
        const tbody = document.getElementById("tableBody");
        const rowCount = tbody.rows.length;
        const newRow = tbody.insertRow();

        // ‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î modal)
        const cell0 = newRow.insertCell(0);
        cell0.innerHTML = `<button class="btn btn-sm btn-outline-secondary" onclick="openModal(this)">${rowCount + 1}</button>`;

        // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≤‡∏Å
        const cell1 = newRow.insertCell(1);
        cell1.innerHTML = `<span class="drag-handle" style="cursor:move;">‚ò∞</span>`;

        // ‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠
        const cell2 = newRow.insertCell(2);
        cell2.innerHTML = `<input type="text" class="form-control w-100" placeholder="‡∏ä‡∏∑‡πà‡∏≠">`;

        // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (7 ‡∏ß‡∏±‡∏ô)
        for (let i = 0; i < 7; i++) {
          const cell = newRow.insertCell(i + 3); // index 3 ‡∏ñ‡∏∂‡∏á 9
          cell.innerHTML = `<input type="number" class="form-control w-100" value="0">`;
        }

        // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        const cellLast = newRow.insertCell(10);
        cellLast.innerHTML = `<button class="btn text-danger" onclick="deleteRow(this)">‚ùå</button>`;
      }



      function deleteRow(button) {
        const row = button.parentNode.parentNode;
        row.remove();
        updateRowNumbers();
      }

      function updateRowNumbers() {
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach((tr, index) => {
          const btn = tr.cells[0].querySelector('button');
          if (btn) btn.textContent = index + 1;
        });
      }

      let currentEditingRow = null;
      function openModal(btn) {
        currentEditingRow = btn.parentNode.parentNode;
        const modal = new bootstrap.Modal(document.getElementById('numberModal'));
        modal.show();
      }

      document.getElementById("confirmRowValue").addEventListener("click", function() {
        const value = document.getElementById("rowValue").value;
        if (currentEditingRow) {
          const inputs = currentEditingRow.querySelectorAll("td input[type='number']");
          inputs.forEach(input => input.value = value);
          bootstrap.Modal.getInstance(document.getElementById('numberModal')).hide();
        }
      });

      function saveDataToStorage() {
        const tbody = document.getElementById("tableBody");
        const data = [];
        for (let row of tbody.rows) {
          const name = row.cells[2].querySelector('input').value;
          const numbers = [];
          for (let i = 3; i <= 9; i++) {
            numbers.push(row.cells[i].querySelector('input').value);
          }
          data.push({ name, numbers });
        }
        localStorage.setItem('tableData', JSON.stringify(data));
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      }

      function loadDataFromStorage() {
        const stored = localStorage.getItem('tableData');
        if (!stored) return;

        const data = JSON.parse(stored);
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        data.forEach((item, index) => {
          const newRow = tbody.insertRow();

          const cell0 = newRow.insertCell(0);
          cell0.innerHTML = `<button class="btn btn-sm btn-outline-secondary" onclick="openModal(this)">${index + 1}</button>`;

          const cellDrag = newRow.insertCell(1);
          cellDrag.innerHTML = `<span class="drag-handle">‚ò∞</span>`;

          const cell1 = newRow.insertCell(2);
          cell1.innerHTML = `<input type="text" class="form-control w-100" value="${item.name}">`;

          for (let i = 0; i < 7; i++) {
            const cell = newRow.insertCell(i + 3);
            cell.innerHTML = `<input type="number" class="form-control w-100" value="${item.numbers[i]}">`;
          }

          const cellLast = newRow.insertCell(10);
          cellLast.innerHTML = '<button class="btn" onclick="deleteRow(this)">‚ùå</button>';
        });
        updateRowNumbers();
      }

      function saveAndOpenPrintView() {
        saveDataToStorage();
        window.open('print.html', '_blank');
      }

      window.addEventListener('load', function () {
        const weekSelect = document.getElementById('weekSelect');
        const weeks = generateWeeks(4);
        weeks.forEach((w, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = w.label;
          weekSelect.appendChild(opt);
        });
        weekSelect.value = 4;
        renderWeekHeader(weeks[4].start);
        weekSelect.addEventListener('change', () => {
          const selectedWeek = weeks[weekSelect.value];
          renderWeekHeader(selectedWeek.start);
        });
        loadDataFromStorage();

        new Sortable(document.getElementById('tableBody'), {
          animation: 150,
          handle: '.drag-handle', // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ
          onEnd: function () {
            const rows = document.querySelectorAll("#tableBody tr");
            rows.forEach((tr, index) => {
              tr.cells[0].querySelector("button").textContent = index + 1;
            });
          }
        });

      });
    </script>
  </body>
</html>