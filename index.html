<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô (Job)</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap">
    <style>
      body {
        font-family: 'Kanit', sans-serif;
      }
      td:first-child {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      td:first-child:hover {
        background-color: #e9ecef;
      }
      .drag-handle {
        cursor: grab;
        user-select: none;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th, td {
        text-align: center;
        padding: 4px;
      }
      input[type="number"] {
        width: 40px;
        text-align: center;
      }
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body>
    <div class="mb-3 px-5 mt-2">
      <label for="weekSelect" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
      <select id="weekSelect" class="form-select"></select>
    </div>
    <div class="container-fluid">
      <div id="capture">
        <table class="table table-striped">
          <thead id="weekHeader">
            <tr>
              <th style="width: 70px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th style="width: 200px;">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th style="width: 100px;">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</th>
              <th style="width: 100px;">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</th>
              <th style="width: 100px;">‡∏û‡∏∏‡∏ò</th>
              <th style="width: 100px;">‡∏û‡∏§‡∏´‡∏±‡∏™</th>
              <th style="width: 100px;">‡∏®‡∏∏‡∏Å‡∏£‡πå</th>
              <th style="width: 100px;">‡πÄ‡∏™‡∏≤‡∏£‡πå</th>
              <th style="width: 100px;">‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</th>
              <th style="width: 50px;"></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
    <button class="btn btn-info mb-2" onclick="addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    <button class="btn btn-primary mb-2" onclick="saveDataToStorage()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="btn btn-success mb-2" onclick="saveAndOpenPrintView()">üì∑ ‡πÄ‡∏ã‡∏ü‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
      const weekSelect = document.getElementById('weekSelect');
      const weekHeader = document.getElementById('weekHeader').querySelector('tr');
      const thaiDays = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];

      function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - ((day + 6) % 7);
        d.setDate(diff);
        return d;
      }

      function formatDate(d) {
        return d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit' });
      }

      function generateWeeks(range = 4) {
        const now = new Date();
        const monday = getMonday(now);
        const options = [];

        for (let i = -range; i <= range; i++) {
          const start = new Date(monday);
          start.setDate(start.getDate() + i * 7);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          options.push({ start, label: `${formatDate(start)} - ${formatDate(end)}` });
        }

        return options;
      }

      function renderWeekHeader(startDate) {
  const baseCells = 2; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏•‡∏≥‡∏î‡∏±‡∏ö + ‡∏ä‡∏∑‡πà‡∏≠
  const lastCell = 1;  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡∏ö (‚ùå)

  // ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà ‡∏•‡∏≥‡∏î‡∏±‡∏ö, ‡∏ä‡∏∑‡πà‡∏≠, ‚ùå)
  while (weekHeader.children.length > baseCells + lastCell) {
    weekHeader.removeChild(weekHeader.children[baseCells]);
  }

  const current = new Date(startDate);
  for (let i = 0; i < 7; i++) {
    const dayName = thaiDays[current.getDay()];
    const th = document.createElement('th');
    th.style.width = "150px";
    th.textContent = `${dayName} ${formatDate(current)}`;
    weekHeader.insertBefore(th, weekHeader.children[weekHeader.children.length - 1]);
    current.setDate(current.getDate() + 1);
  }
}
      function addRow() {
        const tbody = document.getElementById("tableBody");
        const rowCount = tbody.rows.length;
        const newRow = tbody.insertRow();

        const cell0 = newRow.insertCell(0);
        cell0.innerHTML = `
          <span class="drag-handle me-2">‚ò∞</span>
          <span class="row-number">${rowCount + 1}</span>
        `;

        const cell1 = newRow.insertCell(1);
        cell1.innerHTML = '<input type="text" class="form-control w-100" placeholder="‡∏ä‡∏∑‡πà‡∏≠">';

        for (let i = 0; i < 7; i++) {
          const cell = newRow.insertCell(i + 2);
          cell.innerHTML = '<input type="number" class="form-control w-100" value="0">';
        }

        const cellLast = newRow.insertCell(9);
        cellLast.innerHTML = '<button class="btn" onclick="deleteRow(this)">‚ùå</button>';
      }

      function deleteRow(button) {
        const row = button.parentNode.parentNode;
        row.remove();
        updateRowNumbers();
      }

      function updateRowNumbers() {
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach((tr, index) => {
          tr.querySelector('.row-number').textContent = index + 1;
        });
      }

      function saveDataToStorage() {
        const tbody = document.getElementById("tableBody");
        const data = [];
        for (let row of tbody.rows) {
          const name = row.cells[1].querySelector('input').value;
          const numbers = [];
          for (let i = 2; i <= 8; i++) {
            numbers.push(row.cells[i].querySelector('input').value);
          }
          data.push({ name, numbers });
        }
        localStorage.setItem('tableData', JSON.stringify(data));
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      }

      function loadDataFromStorage() {
        const stored = localStorage.getItem('tableData');
        if (!stored) return;

        const data = JSON.parse(stored);
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        data.forEach((item, index) => {
          const newRow = tbody.insertRow();
          const cell0 = newRow.insertCell(0);
          cell0.innerHTML = `
            <span class="drag-handle me-2">‚ò∞</span>
            <span class="row-number">${index + 1}</span>
          `;

          const cell1 = newRow.insertCell(1);
          cell1.innerHTML = `<input type="text" class="form-control w-100" value="${item.name}">`;

          for (let i = 0; i < 7; i++) {
            const cell = newRow.insertCell(i + 2);
            cell.innerHTML = `<input type="number" class="form-control w-100" value="${item.numbers[i]}">`;
          }

          const cellLast = newRow.insertCell(9);
          cellLast.innerHTML = '<button class="btn" onclick="deleteRow(this)">‚ùå</button>';
        });
        updateRowNumbers();
      }

      function saveAndOpenPrintView() {
        saveDataToStorage();
        window.open('print.html', '_blank');
      }

      window.addEventListener('load', function () {
        const weeks = generateWeeks(4);
        weeks.forEach((w, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = w.label;
          weekSelect.appendChild(opt);
        });
        weekSelect.value = 4;
        renderWeekHeader(weeks[4].start);
        weekSelect.addEventListener('change', () => {
          const selectedWeek = weeks[weekSelect.value];
          renderWeekHeader(selectedWeek.start);
        });
        loadDataFromStorage();

        new Sortable(document.getElementById('tableBody'), {
          animation: 150,
          handle: '.drag-handle',
          onEnd: updateRowNumbers
        });
      });
    </script>
  </body>
</html>